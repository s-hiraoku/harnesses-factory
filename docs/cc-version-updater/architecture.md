# CC Version Updater アーキテクチャ

## 概要

Claude Code の新バージョンを検出し、アップグレードを促し、アップグレード後に新機能の使い方を案内するプラグイン。

## フロー図

```
┌─────────────────────────────────────────────────────────────┐
│                    Claude Code 起動                          │
└─────────────────────────────┬───────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────┐
│            SessionStart Hook: version-check.sh              │
└─────────────────────────────┬───────────────────────────────┘
                              ▼
                ┌─────────────────────────┐
                │ changelog-summary.json  │
                │ が存在する？            │
                └───────────┬─────────────┘
                      │
           ┌──────────┴──────────┐
           ▼ Yes                 ▼ No
┌─────────────────┐      ┌─────────────────────┐
│ Claude 生成の   │      │ バージョンチェック  │
│ 要約を表示      │      └──────────┬──────────┘
│ (exit 0)        │                 ▼
└─────────────────┘      ┌─────────────────────┐
                         │ 新バージョンあり？  │
                         └──────────┬──────────┘
                               │
                    ┌──────────┴──────────┐
                    ▼ No                  ▼ Yes
              ┌───────────┐       ┌─────────────────────┐
              │ exit 0    │       │ pending-upgrade.json│
              │ (何もなし)│       │ に保存              │
              └───────────┘       └──────────┬──────────┘
                                             ▼
                                  ┌─────────────────────┐
                                  │ UI に通知を表示     │
                                  │ (exit 0)            │
                                  └─────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│               ユーザー: /update-claude 実行                 │
└─────────────────────────────┬───────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  1. AskUserQuestion: アップグレードする？                   │
│  2. インストール方法を自動検出                              │
│  3. アップグレード実行                                      │
│  4. changelog-interpreter Skill で要約を生成                │
│  5. changelog-summary.json に保存                           │
│  6. 再起動を促すメッセージ表示                              │
└─────────────────────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    次回起動時                               │
│            SessionStart Hook が要約を表示                   │
└─────────────────────────────────────────────────────────────┘
```

## コンポーネント

### 1. SessionStart Hook (`version-check.sh`)

起動時に実行されるスクリプト。

**役割:**
- 新バージョンの検出と通知
- アップグレード後の要約表示

### 2. Command (`/update-claude`)

ユーザーが明示的に呼び出すコマンド。

**役割:**
- アップグレードの確認と実行
- changelog の解釈と要約生成
- 要約の保存

### 3. Skill (`changelog-interpreter`)

Claude が changelog を解釈する際のガイドライン。

**役割:**
- 使い方・ユースケースの生成フォーマット定義
- 解釈の品質担保

## キャッシュファイル

| ファイル | 目的 | 作成タイミング | 削除タイミング |
|----------|------|----------------|----------------|
| `pending-upgrade.json` | 検出した新バージョン情報 | バージョン検出時 | アップグレード完了時 |
| `changelog-summary.json` | Claude 生成の要約 | アップグレード完了時 | 次回起動時（表示後） |

## データフォーマット

### pending-upgrade.json
```json
{
  "previousVersion": "2.0.74",
  "latestVersion": "2.0.75",
  "changelog": "## What's Changed\n- feat: add LSP...",
  "detectedAt": "2025-12-23T12:00:00Z"
}
```

### changelog-summary.json
```json
{
  "previousVersion": "2.0.74",
  "latestVersion": "2.0.75",
  "summary": "🎉 Claude Code v2.0.75 へようこそ！\n\n## 🆕 注目の新機能...",
  "generatedAt": "2025-12-23T12:00:00Z"
}
```
